"use strict";angular.module("mlymapApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/map.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]);var MAP_DEFAULT_VIEW={lat:23.599,lng:121.108,zoom:8};angular.module("mlymapApp").controller("MapCtrl",["$scope","$http","$q","$filter","leafletData","voteInfoService",function(a,b,c,d,e,f){function g(b){var c=[];c.push(a.selectedDistrictName?a.selectedDistrictName:b.properties.county+"-"+b.properties.number),b.properties.TOWNNAME&&c.push(b.properties.TOWNNAME),b.properties.VILLAGENAM&&c.push(b.properties.VILLAGENAM);var d=f.getWinner(c),e="#dd1c77";return"中國國民黨"===d.party?d.ratio>40?"#045a8d":d.ratio>30?"#2b8cbe":d.ratio>20?"#74a9cf":d.ratio>10?"#bdc9e1":"#f1eef6":"民主進步黨"===d.party?d.ratio>40?"#006d2c":d.ratio>30?"#2ca25f":d.ratio>20?"#66c2a4":d.ratio>10?"#b2e2e2":"#edf8fb":e}function h(){setTimeout(function(){$(".county").each(function(a,b){b.classList?b.classList.remove("transparent"):b.getAttribute&&b.getAttribute("class")&&b.setAttribute("class",b.getAttribute("class").replace("transparent",""))})},100)}function i(a){return{fillColor:g(a),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7,className:"county transparent"}}function j(b){a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(b)}):a.geojson={data:b,style:i,resetStyleOnMouseout:!0},h()}function k(a,c){angular.forEach(a["投票狀況"],function(d,e){angular.forEach(d,function(d,f){var g="json/twVillage1982/"+c+"/"+a["選區"][0]+"/"+e+"/"+f+".json";b.get(g).then(function(a){j(a.data)})})})}function l(a,b){var c=b.target;c.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),c.bringToFront()}function m(b,c,d){var f=d.target.feature.properties,g=f.county+"-"+f.number;a.selectedDistrictName=g,e.getMap().then(function(b){b.fitBounds(d.target.getBounds()),a.geojson=null,k(a.voteInfos[g],g)})}a.getWinnerName=function(a,b){if(!a)return"--";var c=a.county+"-"+a.number,d=f.getWinner([c]),e=d.name;return b&&(e+="（"+d.party+"）"),e},a.getWinnerRatio=function(a){if(!a)return"--";var b=a.county+"-"+a.number,c=f.getWinner([b]);return d("number")(c.count)+" 票（"+d("number")(c.ratio,2)+"%）"},a.debug=function(){},a.back=function(){delete a.selectedDistrictName,delete a.geojson,j(a.districts),a.taiwan=MAP_DEFAULT_VIEW},a.leafletData=e,a.taiwan=MAP_DEFAULT_VIEW,a.defaults={zoomControlPosition:"bottomright"},a.$on("leafletDirectiveMap.geojsonMouseover",l),a.$on("leafletDirectiveMap.geojsonClick",m),f.getAllVoteInfo().then(function(){},function(){},function(c){a.voteInfos||(a.voteInfos={}),a.voteInfos[c.id]=c.content;var d="json/twVote1982/"+c.id+".json";b.get(d).then(function(b){a.districts?a.districts.features.push(b.data.features[0]):a.districts=b.data,j(b.data)})})}]),angular.module("mlymapApp").service("voteInfoService",["$q","$http",function(a,b){var c,d={};this.voteInfos=d,this.getCountyIds=function(){var d=a.defer();return c?d.resolve(c):b.get("json/counties.json").then(function(a){c=a.data,d.resolve(a.data)}),d.promise},this.getAllVoteInfo=function(){function e(a){g++,f.notify({id:a,content:d[a]}),g===c.length&&f.resolve(d)}var f=a.defer(),g=0;return this.getCountyIds().then(function(a){angular.forEach(a,function(a){d[a]?e(a):b.get("json/mly/8/"+a+".json").then(function(b){d[a]=b.data,e(a)})})}),f.promise},this.getWinner=function(a){var b={},c=this.voteInfos[a.shift()],d=c;a.length>0?(c=c["投票狀況"],angular.forEach(a,function(a){c=c[a]}),c=c[0]):c=c["小記"]["總計"];var e=c["得票數"],f=e.indexOf(Math.max.apply(this,e));return b.name=d["候選人"][f][1],b.party=d["候選人"][f][2],b.ratio=100*c["得票率"][f],b.count=c["得票數"][f],b}}]);